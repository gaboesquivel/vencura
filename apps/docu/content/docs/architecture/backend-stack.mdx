---
title: "Backend Stack"
description: "Node.js LTS + Fastify runtime, PostgreSQL database, and Drizzle ORM for type-safe, portable backend development."
---

## Overview

The backend uses **Node.js LTS** with **Fastify**, **PostgreSQL**, and **Drizzle ORM**. These standard technologies ensure portability and type safety, allowing migration between deployment platforms without code changes.

## Technology Choices

### Runtime: Node.js LTS

**Node.js LTS** provides:

- ✅ **Stability** - Long-term support with predictable release cycles
- ✅ **Ecosystem** - Largest npm package ecosystem with 100% compatibility
- ✅ **Enterprise support** - Wide adoption and professional support available
- ✅ **Tooling** - Best-in-class debugging, monitoring, and APM tools
- ✅ **Cloud support** - Universal support across AWS, GCP, Azure

### Framework: Fastify

**Fastify** is a fast, low-overhead web framework for Node.js:

- ✅ **Portability** - Runs anywhere (Vercel, Google Cloud Run, AWS ECS, on-premises)
- ✅ **No vendor lock-in** - Standard Node.js app, migrate by changing deployment only
- ✅ **Performance** - Fast, low overhead, production-ready
- ✅ **Functional patterns** - Plugin-based architecture, no classes required
- ✅ **TypeScript support** - Excellent type inference and developer experience
- ✅ **OpenAPI support** - Via plugins for API documentation and AI integration

**Why Fastify?**

We chose **Fastify** as the backend framework because it aligns perfectly with our architectural values: **type-safe**, **fast**, and **simple to reason about**. Combined with **OpenAPI generation** and **Hey API** for client generation, it provides the right balance between performance, developer experience, and long-term maintainability.

**Core Reasons:**

1. **Fastify routes as source**: Routes define the API, OpenAPI spec generated automatically
2. **Type-safe end-to-end**: Full type safety from API routes to client calls via generated clients
3. **Fast and efficient**: High-performance HTTP framework optimized for Node.js
4. **TypeBox schemas**: Native JSON Schema with TypeBox for optimal performance and OpenAPI generation
5. **OpenAPI generation**: Automatic OpenAPI spec generation from Fastify routes via `generate-openapi.ts`
6. **Functional patterns**: Clean, composable route handlers without decorators
7. **ESM-native**: Built for modern ESM from day one, works seamlessly with Node.js and pnpm
8. **Scales elegantly**: Composable plugins, modular route grouping, unified error handling

### Database: PostgreSQL

**PostgreSQL** provides:

- ✅ **ACID transactions** - Full transactional integrity
- ✅ **Extensions** - PostGIS, vector search, full-text search, crypto
- ✅ **Enterprise ready** - Mature, battle-tested, widely supported
- ✅ **Portability** - Standard SQL, works with any PostgreSQL host

### Initial Provider: Supabase

**Supabase** accelerates development:

- ✅ **Managed Postgres** - Fast setup for rapid iteration
- ✅ **Branching** - Preview environments with database branching
- ✅ **Local development** - Supabase CLI for local Postgres
- ✅ **Migration path** - Easy to migrate to Cloud SQL/RDS (only `DATABASE_URL` changes)

### ORM: Drizzle

**Drizzle ORM** provides type-safe database access:

- ✅ **Type safety** - Full TypeScript inference, no code generation
- ✅ **Lightweight** - Minimal runtime overhead
- ✅ **SQL-like syntax** - Intuitive and familiar
- ✅ **Zero vendor lock-in** - Generates plain PostgreSQL queries
- ✅ **PGLite support** - Works with embedded Postgres for testing

## Architecture Flow

```mermaid
sequenceDiagram
  participant Client as Next.js Client
  participant API as Fastify API
  participant Drizzle as Drizzle ORM
  participant DB as PostgreSQL

  Client->>API: HTTP Request
  API->>API: Validate (Zod schemas)
  API->>Drizzle: Type-safe query
  Drizzle->>DB: Plain SQL query
  DB-->>Drizzle: Query result
  Drizzle-->>API: Typed data
  API-->>Client: JSON response
```

## Backend Request Flow

1. **Request arrives** - Fastify receives HTTP request
2. **Validation** - Zod schemas validate request body/params
3. **Business logic** - Handler processes request
4. **Database access** - Drizzle executes type-safe queries
5. **Response** - Typed JSON response returned

## Fastify App Setup

```typescript
// src/index.ts
import Fastify from 'fastify'
import { TypeBoxTypeProvider } from '@fastify/type-provider-typebox'
import walletRoutes from './routes/wallet.js'
import userRoutes from './routes/user.js'

const fastify = Fastify({
  logger: true,
}).withTypeProvider<TypeBoxTypeProvider>()

// Register routes
await fastify.register(walletRoutes)
await fastify.register(userRoutes)

const start = async () => {
  try {
    await fastify.listen({ port: 3000, host: '0.0.0.0' })
  } catch (err) {
    fastify.log.error(err)
    process.exit(1)
  }
}

start()
```

## OpenAPI Generation

OpenAPI specs are generated from Fastify routes via `generate-openapi.ts`. The script scans route definitions and generates OpenAPI 3.0 specification. Hey API then generates TypeScript clients from the OpenAPI spec.

**Flow:**
1. Fastify routes define schemas using TypeBox
2. `generate-openapi.ts` scans routes and generates OpenAPI spec
3. Hey API generates TypeScript clients from OpenAPI spec
4. Full type safety from routes to client calls

## Database Schema Management

Schemas are defined using Drizzle's declarative syntax:

```typescript
import { pgTable, text, timestamp } from 'drizzle-orm/pg-core'

export const users = pgTable('users', {
  id: text('id').primaryKey(),
  email: text('email').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
})
```

Migrations are managed with `drizzle-kit`:

- `db:generate` - Generate migration files from schema changes
- `db:migrate` - Apply migrations to database

## Portability Strategy

The entire backend stack is designed for **zero vendor lock-in**:

- **Fastify** - Standard Node.js process, runs anywhere
- **Drizzle** - Generates plain SQL, no proprietary runtime
- **PostgreSQL** - Standard SQL, works with any Postgres host
- **Migration** - Only requires changing `DATABASE_URL`

See [Portability Strategy](/docs/architecture/portability) for detailed migration paths.

## Security

The API implements comprehensive security measures:

- **Security Headers** - X-Content-Type-Options, X-Frame-Options, CSP, HSTS, and more
- **CORS** - Configurable origin restrictions
- **Rate Limiting** - Per-IP rate limiting to prevent abuse
- **Input Validation** - Zod schemas for all requests
- **Security Logging** - Automatic logging of security events
- **Trust Proxy** - Proper IP detection behind Vercel/Cloudflare

See [Security Guide](/docs/security#api-security) for detailed security configuration.

## Related Documentation

- [API Architecture](/docs/core-concepts/api-architecture) - REST API with OpenAPI and client generation
- [Portability Strategy](/docs/architecture/portability) - Migration and portability details
- [Security Guide](/docs/security) - Security baseline and API security
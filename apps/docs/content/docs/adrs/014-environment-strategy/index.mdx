---
title: "ADR 014: Environment Strategy"
description: "Decision to implement environment-based configuration strategy with separate files for development, staging, and production, mapping to appropriate blockchain networks."
---

## Status

Accepted

## Context

We need a unified environment strategy across the monorepo that:

- Separates local development, staging, and production configurations
- Maps environments to appropriate blockchain networks (testnet/mainnet)
- Works consistently across Next.js apps and Elysia-based Vencura API
- Supports CI/CD with testnet-based testing
- Integrates with Vercel deployment workflows
- **Zod-validated** environment configuration for type safety and DX

## Decision

We will implement an environment-based configuration strategy with the following structure:

### Environment Files

- **`.env`**: Sensitive local secrets (never committed, highest priority)
- **`.env.development`**: Local development with testnet networks (Arbitrum Sepolia)
- **`.env.staging`**: Testnet configuration (Sepolia, Arbitrum Sepolia, etc.)
- **`.env.production`**: Mainnet/real chains configuration
- **`.env.test`**: Test-specific configuration (uses testnet networks)

### Environment Loading Priority

**Vencura API (Elysia backend):**

- Bun automatically loads `.env` files (no manual loading needed)
- Uses standard `.env` file (sensitive data, never committed)
- Environment-specific files (`.env.development`, `.env.staging`, etc.) are not automatically loaded by Bun

**Next.js Apps:**

- Next.js built-in env loading handles priority automatically:
  1. `.env.local` (highest priority, never committed)
  2. `.env.development` / `.env.production` / `.env.test` (based on NODE_ENV)
  3. `.env` (fallback, lowest priority)

### Blockchain Network Mapping

| Environment | Blockchain Network                   | Use Case                      |
| ----------- | ------------------------------------ | ----------------------------- |
| Development | Testnets (Arbitrum Sepolia)          | Local development and testing |
| Staging     | Testnets (Sepolia, Arbitrum Sepolia) | Pre-production validation     |
| Production  | Mainnet (real chains)                | Live production environment   |
| Test        | Testnets (Arbitrum Sepolia)          | CI/CD and automated tests     |

### Git Branch Mapping

- **`main` branch** → Production environment → `.env.production` → Mainnet
- **`develop` branch** → Staging environment → `.env.staging` → Testnets
- **Feature branches** → Development environment → `.env.development` → Testnets

### Environment Configuration

**Next.js Apps:**
- Enforce **Zod-validated** environment configuration objects (`zEnv`) using Zod schemas and `@vencura/lib` utilities
- **Type safety**: Full TypeScript inference from Zod schemas (`z.infer<typeof envSchema>`)
- **Fail fast**: Invalid config causes immediate failure at module load with clear error messages
- **DX-focused**: Fast failure, clear error messages, no manual error checks needed

**Elysia API:**
- Uses Bun's built-in `.env` file loading (no manual loading needed)
- Exports `environment` object with TypeScript type safety via Zod schema
- No runtime validation (relies on Bun's environment handling)
- **Type safety**: Full TypeScript inference from Zod schemas (`z.infer<typeof envSchema>`)

## Implementation

### Environment Validation Enforcement

All apps now enforce validated environment configuration objects (`zEnv`) using Zod schemas and `@vencura/lib` utilities:

**Vencura API (`apps/api` - Elysia backend):**
- Created `apps/api/src/lib/env.ts` with Zod schema for type inference
- Uses Bun's built-in `.env` file loading (no manual loading needed)
- Exports `environment` object that reads directly from `process.env`
- Replaced all `process.env` usage with `environment`
- **Type-safe**: TypeScript type safety via Zod schema, no runtime validation overhead

**Next.js Apps (`apps/web`, `apps/mathler`):**
- Updated existing `lib/env.ts` files to export `zEnv` const object
- Already using `getEnvHelper` from `@vencura/lib` and Zod schemas
- Validation happens at module load (build time for `NEXT_PUBLIC_*` vars)

### Key Benefits

- **Type Safety**: Full TypeScript inference from Zod schemas (`z.infer<typeof envSchema>`)
- **Next.js Apps**: Fail fast - invalid config causes immediate failure at module load
- **Elysia API**: Simple and fast - uses Bun's built-in env loading, no validation overhead
- **No Manual Checks**: Zod handles all validation (Next.js) or runtime behavior (Elysia API)
- **Consistent Pattern**: Next.js apps use `@vencura/lib` utilities, Elysia API uses Bun's built-in loading
- **Next.js Compatible**: Handles `NEXT_PUBLIC_*` build-time replacement correctly

### Dev Scripts

- Added `dev:local` script to start apps with development env
- Added `dev:staging` script to start apps with staging env
- All scripts use `bun` as package manager

### CI/CD

- GitHub Actions workflows use `.env.test` configuration
- Tests run against Arbitrum Sepolia testnet
- Automated gas funding via `ARB_TESTNET_GAS_FAUCET_KEY`

## Consequences

### Positive

- **Clear separation** of environments and blockchain networks
- **Consistent patterns** across Next.js and Elysia-based API
- **Zod-first validation** ensures type safety and clear error messages
- **DX-focused** environment handling with fast failure and no manual checks
- **Local development** uses testnet networks (Dynamic SDK requirement)
- **CI/CD** runs tests with testnet networks (automated gas funding)
- **Staging** validates against testnets before production
- **Production** uses mainnet with proper security controls

### Negative

- **Additional configuration** files to manage (mitigated by example files)
- **Learning curve** for new contributors (mitigated by documentation)

### Neutral

- **Backward compatibility**: Existing `.env` files still work as fallback
- **Migration path**: Teams can gradually adopt environment-specific files

## Alternatives Considered

### Alternative 1: Single .env file with NODE_ENV-based logic

**Rejected because:**

- Less clear separation of concerns
- Harder to manage different RPC URLs per environment
- Mixing local secrets with environment configs

### Alternative 2: Environment variables only (no .env files)

**Rejected because:**

- Poor developer experience (harder to set up locally)
- No version-controlled examples
- More complex CI/CD setup

### Alternative 3: Custom env loading solution for Next.js

**Rejected because:**

- Next.js already has built-in support
- No need to reinvent the wheel
- Built-in solution is well-tested and documented

## Related ADRs

- [ADR 010: Vencura Infrastructure Orchestration](/docs/adrs/010-vencura-infra-orchestration)
- [ADR 013: Vencura API Test Gas Faucet](/docs/adrs/013-vencura-api-test-gas-faucet)

## References

- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
- [Elysia Documentation](https://elysiajs.com)
- [Zod Documentation](https://zod.dev)

---
title: "ADR 014: Environment Strategy"
description: "Decision to implement environment-based configuration strategy with separate files for development, staging, and production, mapping to appropriate blockchain networks."
---

## Status

Accepted

## Context

We need a unified environment strategy across the monorepo that:

- Separates local development, staging, and production configurations
- Maps environments to appropriate blockchain networks (local/testnet/mainnet)
- Works consistently across Next.js apps and NestJS API
- Supports CI/CD with local blockchain testing
- Integrates with Vercel deployment workflows

## Decision

We will implement an environment-based configuration strategy with the following structure:

### Environment Files

- **`.env.local`**: Sensitive local secrets (never committed, highest priority)
- **`.env.development`**: Local development with local blockchain networks (Anvil)
- **`.env.staging`**: Testnet configuration (Sepolia, Arbitrum Sepolia, etc.)
- **`.env.production`**: Mainnet/real chains configuration
- **`.env.test`**: Test-specific configuration (uses local blockchain)

### Environment Loading Priority

**NestJS API:**

1. `.env.local` (highest priority)
2. `.env.<NODE_ENV>` (development/staging/production/test)
3. `.env` (fallback, lowest priority)

**Next.js Apps:**

- Next.js built-in env loading handles priority automatically:
  1. `.env.local` (highest priority, never committed)
  2. `.env.development` / `.env.production` / `.env.test` (based on NODE_ENV)
  3. `.env` (fallback, lowest priority)

### Blockchain Network Mapping

| Environment | Blockchain Network                   | Use Case                      |
| ----------- | ------------------------------------ | ----------------------------- |
| Development | Local Anvil                          | Local development and testing |
| Staging     | Testnets (Sepolia, Arbitrum Sepolia) | Pre-production validation     |
| Production  | Mainnet (real chains)                | Live production environment   |
| Test        | Local Anvil                          | CI/CD and automated tests     |

### Git Branch Mapping

- **`main` branch** → Production environment → `.env.production` → Mainnet
- **`develop` branch** → Staging environment → `.env.staging` → Testnets
- **Feature branches** → Development environment → `.env.development` → Local Anvil or Testnets

### Default Behavior

- **`USE_LOCAL_BLOCKCHAIN`**:
  - Defaults to `true` for `development` and `test` environments
  - Defaults to `false` for `staging` and `production` environments

## Implementation

### Environment Validation Enforcement

All apps now enforce validated environment configuration objects (`zEnv`) using Zod schemas and `@vencura/lib` utilities:

**API App (`apps/api`):**
- Created `apps/api/src/lib/env.ts` with Zod schema
- Uses `validateEnvOrThrow` from `@vencura/lib` (fails fast on invalid config)
- Exports `zEnv` const object validated at module load
- Replaced all `process.env` usage with `zEnv`

**Elysia App (`apps/elysia`):**
- Created `apps/elysia/src/lib/env.ts` with Zod schema
- Uses `validateEnvOrThrow` from `@vencura/lib`
- Exports `zEnv` const object validated at module load
- Replaced all `process.env` usage with `zEnv`

**Next.js Apps (`apps/next`, `apps/mathler`):**
- Updated existing `lib/env.ts` files to export `zEnv` const object
- Already using `getEnvHelper` from `@vencura/lib` and Zod schemas
- Validation happens at module load (build time for `NEXT_PUBLIC_*` vars)

### Key Benefits

- **Type Safety**: Full TypeScript inference from Zod schemas (`z.infer<typeof envSchema>`)
- **Fail Fast**: Invalid config causes immediate failure at module load
- **No Manual Checks**: Zod handles all validation - removed manual error checks
- **Consistent Pattern**: All apps follow same pattern using `@vencura/lib` utilities
- **Next.js Compatible**: Handles `NEXT_PUBLIC_*` build-time replacement correctly

### Dev Scripts

- Created `scripts/start-anvil.sh` for shared Anvil startup
- Added `dev:local` script to start Anvil + apps with development env
- Added `dev:staging` script to start apps with staging env (no local blockchain)

### CI/CD

- GitHub Actions workflows use `.env.test` with `USE_LOCAL_BLOCKCHAIN=true`
- Anvil starts automatically in CI for test execution
- Tests run against local blockchain, not testnets

## Consequences

### Positive

- **Clear separation** of environments and blockchain networks
- **Consistent patterns** across Next.js and NestJS
- **Local development** uses local blockchain by default (faster, no network dependency)
- **CI/CD** runs tests with local blockchain (no testnet dependency, faster, more reliable)
- **Staging** validates against testnets before production
- **Production** uses mainnet with proper security controls

### Negative

- **Additional configuration** files to manage (mitigated by example files)
- **Learning curve** for new contributors (mitigated by documentation)

### Neutral

- **Backward compatibility**: Existing `.env` files still work as fallback
- **Migration path**: Teams can gradually adopt environment-specific files

## Alternatives Considered

### Alternative 1: Single .env file with NODE_ENV-based logic

**Rejected because:**

- Less clear separation of concerns
- Harder to manage different RPC URLs per environment
- Mixing local secrets with environment configs

### Alternative 2: Environment variables only (no .env files)

**Rejected because:**

- Poor developer experience (harder to set up locally)
- No version-controlled examples
- More complex CI/CD setup

### Alternative 3: Custom env loading solution for Next.js

**Rejected because:**

- Next.js already has built-in support
- No need to reinvent the wheel
- Built-in solution is well-tested and documented

## Related ADRs

- [ADR 010: Vencura Infrastructure Orchestration](/docs/adrs/010-vencura-infra-orchestration)
- [ADR 013: Vencura API Test Gas Faucet](/docs/adrs/013-vencura-api-test-gas-faucet)

## References

- [Next.js Environment Variables](https://nextjs.org/docs/basic-features/environment-variables)
- [NestJS Configuration](https://docs.nestjs.com/techniques/configuration)
- [Foundry Anvil Documentation](https://book.getfoundry.sh/anvil/)

# Vencura API

A multichain custodial wallet backend API built with NestJS, Dynamic authentication, and PGLite.

## Overview

Vencura is a backend API that enables users to create and manage custodial wallets across multiple blockchain networks. It provides secure wallet operations including balance queries, message signing, and transaction sending on supported chains including EVM chains (Ethereum, Arbitrum, Base, Polygon, Optimism) and Solana.

## Features

- **Multichain Support**: Create and manage wallets on multiple blockchain networks
  - **EVM Chains**: Ethereum, Arbitrum, Base, Polygon, Optimism, and all viem-supported EVM chains
  - **Solana**: Mainnet, Devnet, and Testnet
  - **Future Support**: Cosmos, Bitcoin, Flow, StarkNet, Algorand, Sui, Spark, Tron
- **Dynamic Authentication**: Secure user authentication using `@dynamic-labs/sdk-api`
- **Dynamic Wallets**: Server-side wallet management using Dynamic SDK
  - `@dynamic-labs-wallet/node-evm` for EVM chains
  - `@dynamic-labs-wallet/node-svm` for Solana
- **Custodial Wallets**: Create and manage wallets on the backend with 2-of-2 threshold signatures
- **Blockchain Operations**:
  - Get wallet balance (chain-agnostic)
  - Sign messages with wallet private keys
  - Send transactions on any supported chain
- **RPC Configuration**: Uses Dynamic's default RPC URLs with optional per-chain overrides
- **Database**: DrizzleORM with PGLite (development) or Cloud SQL Postgres (production)
- **API Documentation**: Interactive Swagger UI at `/api` (disabled by default, enable with `ENABLE_SWAGGER_UI=true`)
- **TypeScript SDK**: Auto-generated `@vencura/core` SDK from Swagger/OpenAPI specification
- **Security**:
  - AES-256-GCM encryption for private key storage
  - Rate limiting on all endpoints
  - Input validation with chain ID validation
  - Security headers (HSTS, X-Frame-Options, CSP, etc.)
  - Request size limits (10kb maximum)
  - Request ID tracing for all requests
  - Error message sanitization in production
  - Proper 429 rate limit error handling
  - Swagger UI protected by feature flag (disabled by default)
  - CORS configuration
  - DDoS protection via Cloudflare

## Tech Stack

- **Framework**: NestJS
- **Authentication**: Dynamic Labs SDK Client
- **Validation**: Zod for environment variables and runtime validation
- **Utilities**: `@vencura/lib` for error handling, async utilities, and zod utilities
- **Blockchain**:
  - Viem for EVM chains
  - @solana/web3.js for Solana
  - Dynamic SDK for wallet operations
- **Database**: DrizzleORM with PGLite (development) or Cloud SQL Postgres (production)
- **API Documentation**: Swagger/OpenAPI (generates `@vencura/core` TypeScript SDK)
- **Infrastructure**: Vercel with Google Cloud option

## Getting Started

### Prerequisites

- Node.js >= 20.0.0
- pnpm (package manager)

### Installation

```bash
pnpm install
```

### Environment Variables

This API uses environment-specific configuration files. Environment files are loaded in priority order:

1. `.env` (highest priority, sensitive data, never committed, overrides everything)
2. `.env.development` / `.env.staging` / `.env.production` / `.env.test` (based on NODE_ENV, committed configs)

**File Structure:**

- `.env` - Sensitive data (API keys, tokens, secrets) - **NEVER COMMIT**
- `.env.development` - Development configuration (committed, non-sensitive) - Testnet networks
- `.env.staging` - Staging configuration (committed, non-sensitive) - Testnet networks
- `.env.production` - Production configuration (committed, non-sensitive) - Mainnet networks
- `.env.test` - Test configuration (committed, non-sensitive) - Arbitrum Sepolia testnet (for CI/CD)
- `.env-example` - Template for `.env` file (shows required sensitive variables)

**Setup for Local Development:**

```bash
# Copy the example file for sensitive data
cp .env-example .env

# Fill in your actual sensitive values in .env
# DYNAMIC_ENVIRONMENT_ID=your_environment_id
# DYNAMIC_API_TOKEN=your_api_token
# ENCRYPTION_KEY=your_32_char_encryption_key_minimum

# .env.development is already committed with non-sensitive configs
```

**Required Environment Variables:**

- `DYNAMIC_ENVIRONMENT_ID` - Dynamic Labs environment ID from the [Dynamic Dashboard](https://app.dynamic.xyz/)
- `DYNAMIC_API_TOKEN` - Dynamic Labs API token from the [Dynamic Dashboard](https://app.dynamic.xyz/)
- `ENCRYPTION_KEY` - Encryption key for private key storage (32+ characters, random string)

**Optional Environment Variables:**

- `PORT` - Server port (default: 3077)
- `USE_LOCAL_BLOCKCHAIN` - Use local Anvil blockchain (default: `true` for development/test, `false` for staging/production)
- `RPC_URL_<CHAIN_ID>` - Per-chain RPC URL overrides (e.g., `RPC_URL_421614`, `RPC_URL_84532`)
- `ARBITRUM_SEPOLIA_RPC_URL` - Legacy Arbitrum Sepolia RPC URL (backward compatibility)
- `SOLANA_RPC_URL` - Solana RPC URL
- `OPEN_AI_KEY` - OpenAI API key for AI features
- `SENTRY_DSN` - Sentry error tracking DSN
- `SENTRY_ENVIRONMENT` - Sentry environment name
- `ENABLE_SWAGGER_UI` - Enable Swagger UI (default: `false`)
- `FAUCET_PRIVATE_KEY` - Testnet faucet private key (for automated funding)

## Development

```bash
# Start development server
pnpm start:dev

# Run tests
pnpm test

# Run E2E tests
pnpm run test:e2e

# Lint
pnpm lint

# Type check
pnpm typecheck
```

## API Endpoints

### Wallets

- `GET /wallets` - List all wallets for authenticated user
- `POST /wallets` - Create a new wallet
- `GET /wallets/:id` - Get wallet details
- `GET /wallets/:id/balance` - Get wallet balance
- `POST /wallets/:id/sign` - Sign a message
- `POST /wallets/:id/send` - Send a transaction

## Testing

The API uses a **blackbox testing strategy** with local chains for automation:

- **Local Chain Automation**: Anvil spins up automatically before tests to save gas costs
- **Token Mocking**: Test tokens (USDT, USDC, DNMC) are automatically deployed with open mint functionality
- **Dynamic SDK Integration**: All transaction signing uses the real Dynamic SDK (no mocks)
- **Blackbox Testing**: All tests hit HTTP endpoints only, ensuring end-to-end validation

## Related Documentation

- [Environment Strategy](/docs/environment) - Environment variable configuration
- [Deployment](/docs/deployment) - Deployment and branching strategy
- [@vencura/core](/docs/packages/core) - TypeScript SDK
- [@vencura/react](/docs/packages/react) - React hooks


# API

Type-safe REST API built with Fastify & OpenAPI.

The API provides a RESTful interface with end-to-end type safety from OpenAPI specifications to generated clients. Built on Fastify for high performance. Fastify routes are the source of truth and the OpenAPI spec is generated from route definitions via `generate-openapi.ts`.

## Requirements

- **Node.js**: `>=22`
- **pnpm**: `10.28.0`

## Development

```bash
pnpm dev
```

Starts Fastify server with hot reload at [http://localhost:3000](http://localhost:3000).

## Scripts

- `pnpm dev` - Development server with hot reload
- `pnpm build` - Build TypeScript
- `pnpm start` - Production server (requires build)
- `pnpm test` - Run tests
- `pnpm checktypes` - Type-check without emitting output
- `pnpm generate:openapi` - Generate OpenAPI specification from Fastify routes (uses dummy `OPENAI_API_KEY` if missing)

All runtime scripts build `@repo/utils` first to ensure compiled workspace dependencies are available.

## Testing

Tests run with Vitest in ESM mode against the TypeScript source.

## Environment Variables

The API uses environment variables for configuration. See [Environment Setup Guide](@apps/docu/content/docs/getting-started/installation.mdx) for complete details.
The server loads `apps/fastify/.env` using Node.js native `--env-file` flag (Node.js 20.6+).

### Required
- `NODE_ENV` - Environment mode (`development`, `test`, `production`)

### Optional
- `PORT` - Server port (default: `3000`)
- `HOST` - Server host (default: `0.0.0.0`)
- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string
- `OPENAI_API_KEY` - OpenAI API key (required in production; dev uses a dummy default)
- `SENTRY_DSN` - Sentry DSN for error tracking
- `SENTRY_ENVIRONMENT` - Sentry environment name
- `SENTRY_TRACES_SAMPLE_RATE` - Sentry traces sample rate (default: `1`)
- `SENTRY_REPLACES_HEADERS` - Replace headers with Sentry (default: `false`)
- `SENTRY_REPLACES_PROD_ENV` - Replace production env with Sentry (default: `false`)
- `REQUEST_TIMEOUT` - Request timeout in milliseconds (default: `30000`)

## Deployment

The API can be deployed to multiple platforms with zero code changes:

- **Vercel** (Development) - Serverless functions via `vercel.json`
- **Google Cloud Run** (Production) - Containerized deployment
- **AWS ECS/EC2** (Production) - Container or VM deployment

See [Deployment Guide](https://vencura-docs.vercel.app/docs/guides/deployment) for detailed deployment instructions and [Portability Strategy](https://vencura-docs.vercel.app/docs/portability) for migration paths.

### Vercel Deployment

When deploying to Vercel, the serverless function is located at `api/[...].ts` (configured in `vercel.json`). All requests are rewritten to `/fastify` to route to this function. This configuration ensures the Fastify application runs correctly in Vercel's serverless environment.

## API Documentation

- **Scalar UI**: `/reference`
- **OpenAPI Spec**: `/reference/openapi.json`
- **Health Check**: `GET /health`

## Architecture

REST API architecture using OpenAPI:

- **Routes**: Implemented in `src/routes/` (Fastify plugins) - the source of truth
- **OpenAPI Spec**: Generated in `openapi/openapi.json` from Fastify routes via `generate-openapi.ts`
- **Clients**: Generated by Hey API in `@repo/core` and `@repo/react` from the OpenAPI spec
- **Type Safety**: End-to-end from routes → OpenAPI spec → generated clients
- **Schemas**: Zod schemas are converted to JSON Schema via `zod-to-json-schema` for Fastify validation/OpenAPI
- **Framework**: Fastify for high-performance HTTP server
- **Validation**: Zod schemas for runtime validation

Fastify routes are the source of truth. The OpenAPI specification is automatically generated from route definitions, ensuring consistency between implementation and documentation. This enables type-safe client generation across the entire stack from API to client.

See [Backend Stack](@apps/docu/content/docs/architecture/backend-stack.mdx) and [API Development](@apps/docu/content/docs/core-concepts/api-architecture.mdx) for details.

---
description: Backend testing standards and patterns for Fastify
alwaysApply: false
---
# Backend Testing Rules

See @.cursor/rules/base/testing.mdc for common testing philosophy, coverage requirements, and mocking guidelines.

## Test Structure
### E2E Tests (Blackbox API Testing)
- **Location**: `test/*.e2e-spec.ts` or `src/**/*.spec.ts`
- **Pattern**: Tests only interact with HTTP endpoints, not internal implementation
- **Real APIs**: All tests use real external service endpoints (no mocks)
- **Fastify Testing**: Use `fastify.inject()` to simulate HTTP requests for blackbox testing

## Vitest Configuration
**All Fastify tests run in ESM mode** - Vitest is ESM-native and tests TypeScript source directly:
- Tests run against TypeScript source files (ESM), not built output
- Vitest config uses `vitest.config.ts` with ESM syntax
- Path aliases configured in Vitest config for `@repo/*` imports
- Test utilities available in `src/test/utils/fastify.ts` for route testing

## Fastify Route Testing Pattern
Use `fastify.inject()` for blackbox testing of routes:
```typescript
import Fastify from 'fastify'
import { walletRoutes } from '../routes/wallet'

const fastify = Fastify({ logger: false })
await fastify.register(walletRoutes)

const response = await fastify.inject({
  method: 'POST',
  url: '/wallets',
  payload: { name: 'Test Wallet' },
})

expect(response.statusCode).toBe(201)
expect(JSON.parse(response.body)).toMatchObject({
  id: expect.any(String),
  name: 'Test Wallet',
})
```

## Response Validation Pattern
Test that responses match OpenAPI schemas:
```typescript
import { createApi } from '@repo/core'
import { WalletSchema } from '@repo/core'

const api = createApi({ baseUrl: 'http://localhost:3000' })
const wallet = await api.wallets.getWallet({ params: { id: '123' } })

WalletSchema.parse(wallet) // Validate against schema
```

## Running Tests
```bash
pnpm test              # Run all tests
pnpm test:watch        # Run tests in watch mode
pnpm test:cov          # Run tests with coverage
```

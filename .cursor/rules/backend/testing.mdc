---
description: Backend testing standards and patterns for Elysia
globs: *.spec.ts,**/*.e2e-spec.ts,**/*test.ts
alwaysApply: false
---

# Backend Testing Rules

## Testing Philosophy
**CRITICAL**: All tests use real APIs with real API keys. NO MOCKS allowed for core functionality.
- E2E tests hit real Dynamic SDK endpoints (no unit tests)
- Integration tests use real blockchain RPCs
- Tests run exclusively against Arbitrum Sepolia testnet (chain ID: 421614)
- Automated gas faucet funds wallets with minimum ETH required (calculated dynamically with 20% buffer)

## Test Structure
### E2E Tests (Blackbox API Testing)
- **Location**: `test/*.e2e-spec.ts` or `src/**/*.spec.ts`
- **Pattern**: Tests only interact with HTTP endpoints, not internal implementation
- **Real APIs**: All tests use real Dynamic SDK endpoints (no mocks)
- **Elysia Testing**: Use `app.handle()` to simulate HTTP requests for blackbox testing

## Test Coverage Requirements
**For endpoints only, never unit test in API:**
- Wallet Creation (EVM and Solana via Dynamic SDK)
- Balance Queries (both chain types)
- Message Signing (both chain types)
- Transaction Sending (with automated gas funding)
- Error Handling (all error cases and validation)
- User Isolation (users can only access their own wallets)
- Multichain Support (all supported chains)

## Vitest Configuration
**All Elysia tests run in ESM mode** - Vitest is ESM-native and tests TypeScript source directly:
- Tests run against TypeScript source files (ESM), not built output
- Vitest config uses `vitest.config.ts` with ESM syntax
- Path aliases configured in Vitest config for `@vencura/*` imports
- Test utilities available in `src/test/utils/elysia.ts` for route testing

## Elysia Route Testing Pattern

Use `app.handle()` for blackbox testing of routes:

```typescript
import { describe, it, expect } from 'vitest'
import { Elysia } from 'elysia'
import { helloRoute } from '../routes/hello'
import { testRoute } from '../test/utils/elysia'

describe('helloRoute', () => {
  it('should return hello message via HTTP endpoint', async () => {
    // Blackbox test: hit HTTP endpoint, not internal handler
    const response = await testRoute(helloRoute, {
      method: 'GET',
      path: '/hello',
    })
    const data = await response.json()
    
    // Validate response matches contract
    expect(response.status).toBe(200)
    expect(data).toEqual({ message: 'Hello, World!' })
  })
})
```

## Running Tests

```bash
# Run all tests
bun run test

# Run tests in watch mode
bun run test:watch

# Run tests with coverage
bun run test:cov
```

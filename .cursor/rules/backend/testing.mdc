---
description: Backend testing standards and patterns for NestJS
globs: *.spec.ts,**/*.e2e-spec.ts,**/*test.ts
alwaysApply: false
---
# Backend Testing Rules

## Testing Philosophy

**CRITICAL**: All tests use real APIs with real API keys. NO MOCKS allowed for core functionality.

- E2E tests hit real Dynamic SDK endpoints
- Integration tests use real blockchain RPCs
- All API calls use actual credentials from environment variables
- Tests verify end-to-end functionality with real infrastructure

**Automated Gas Faucet**: Transaction tests use automated gas faucet infrastructure that funds wallets with minimum ETH required for transactions on Arbitrum Sepolia testnet. The faucet calculates the exact gas needed (with a 20% buffer) and sends only that amount. Tests run exclusively against Arbitrum Sepolia testnet (chain ID: 421614) because Dynamic SDK doesn't support localhost chains.

## Test Structure

### E2E Tests (Blackbox API Testing)

- **Location**: `test/*.e2e-spec.ts`
- **Pattern**: Tests only interact with HTTP endpoints, not internal implementation
- **Real APIs**: All tests use real Dynamic SDK endpoints (no mocks)
- **Automated**: Tests run without manual intervention
- **Comprehensive**: Tests cover all wallet endpoints, error cases, and multichain scenarios

**Example Structure:**
```typescript
describe('WalletController (e2e)', () => {
  let app: INestApplication<App>
  let authToken: string

  beforeAll(async () => {
    // Setup real app with real Dynamic SDK
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule],
    }).compile()
    app = moduleFixture.createNestApplication()
    await app.init()
    
    // Get real Dynamic auth token
    authToken = await getTestAuthToken()
  })

  it('should create wallet using Dynamic SDK', async () => {
    // Test hits real API endpoint which uses real Dynamic SDK
    return request(app.getHttpServer())
      .post('/wallets')
      .set('Authorization', `Bearer ${authToken}`)
      .send({ chainId: 421614 })
      .expect(201)
      .expect(res => {
        // Verify response structure matches Dynamic SDK output
        expect(res.body).toHaveProperty('address')
        expect(res.body.address).toMatch(/^0x[a-fA-F0-9]{40}$/)
      })
  })
})
```

### Unit Tests (Service/Controller Testing)

- **Location**: `src/**/*.spec.ts`
- **Pattern**: Test individual services/controllers in isolation
- **Mocking**: Only mock external dependencies (database, external APIs)
- **Real Logic**: Test actual business logic without mocks

**Example Structure:**
```typescript
describe('WalletService', () => {
  let service: WalletService
  let mockDb: any
  let mockEncryptionService: jest.Mocked<EncryptionService>

  beforeEach(async () => {
    // Mock only external dependencies
    mockDb = { insert: jest.fn(), select: jest.fn() }
    mockEncryptionService = { encrypt: jest.fn(), decrypt: jest.fn() }

    const module = await Test.createTestingModule({
      providers: [
        WalletService,
        { provide: 'DATABASE', useValue: mockDb },
        { provide: EncryptionService, useValue: mockEncryptionService },
      ],
    }).compile()

    service = module.get<WalletService>(WalletService)
  })

  it('should create wallet with proper structure', async () => {
    // Test actual service logic
    const result = await service.createWallet('user-123', 421614)
    expect(result).toHaveProperty('address')
  })
})
```

## Test Coverage Requirements ( for endpoints, never unit test in api )

### Required Coverage 

- **Wallet Creation**: Test EVM and Solana wallet creation via Dynamic SDK
- **Balance Queries**: Test balance retrieval for both chain types
- **Message Signing**: Test message signing for both chain types
- **Transaction Sending**: Test transaction sending with automated gas funding (local Anvil or testnet faucet)
- **Error Handling**: Test all error cases and validation
- **User Isolation**: Test that users can only access their own wallets
- **Multichain Support**: Test all supported chains

### Test Files Organization

- `test/wallet.e2e-spec.ts` - Main wallet endpoint tests (real APIs)
- `test/wallet-transactions.e2e-spec.ts` - Transaction sending tests (uses automated gas faucet)
- `test/wallet-multichain.e2e-spec.ts` - Multichain wallet creation tests (real APIs)
- `test/wallet-edge-cases.e2e-spec.ts` - Edge case and error handling tests (real APIs)
- `test/app.e2e-spec.ts` - Basic health check tests

## Dynamic SDK Integration Testing

### Wallet Creation Verification

Tests must verify that wallets are created through Dynamic SDK:

```typescript
it('should create wallet using Dynamic SDK', async () => {
  const response = await request(app.getHttpServer())
    .post('/wallets')
    .set('Authorization', `Bearer ${authToken}`)
    .send({ chainId: 421614 })
    .expect(201)

  // Verify response structure matches Dynamic SDK output
  expect(response.body).toHaveProperty('address')
  expect(response.body).toHaveProperty('network')
  expect(response.body).toHaveProperty('chainType')
  
  // Verify address format (EVM addresses are 0x-prefixed hex)
  expect(response.body.address).toMatch(/^0x[a-fA-F0-9]{40}$/)
})
```

### Message Signing Verification

Tests must verify signatures are created via Dynamic SDK:

```typescript
it('should sign message using Dynamic SDK', async () => {
  const wallet = await createTestWallet({ app, authToken, chainId: 421614 })
  
  const response = await request(app.getHttpServer())
    .post(`/wallets/${wallet.id}/sign`)
    .set('Authorization', `Bearer ${authToken}`)
    .send({ message: 'Test message' })
    .expect(200)

  // Verify signature format (EVM signatures are 0x-prefixed hex)
  expect(response.body.signedMessage).toMatch(/^0x[a-fA-F0-9]+$/)
})
```

## Environment Setup

### Required Environment Variables

Tests require these environment variables to use real APIs:

- `DYNAMIC_ENVIRONMENT_ID` - Dynamic environment ID
- `DYNAMIC_API_TOKEN` - Dynamic API token (used directly for authentication in test mode)
- `ENCRYPTION_KEY` - Encryption key (32+ characters)
- `ARB_TESTNET_GAS_FAUCET_KEY` (required) - Private key for Arbitrum Sepolia gas faucet
- `RPC_URL_<CHAIN_ID>` (optional) - Override RPC URLs. Defaults to public Arbitrum Sepolia RPC
- `TEST_AUTH_TOKEN` (optional) - Pre-configured JWT token for testing (not needed in test mode, API key is used)

### Test Authentication

When `NODE_ENV=test`:
- Tests use `DYNAMIC_API_TOKEN` directly for authentication (no JWT generation needed)
- `AuthGuard` accepts API key as authentication in test mode
- Consistent test user (`test-user-${environmentId}`) is used for all tests
- This eliminates network calls and makes tests faster and more reliable

### Testnet-Only Testing Strategy

Tests run exclusively against Arbitrum Sepolia testnet (chain ID: 421614):
- **Why no local blockchain**: Dynamic SDK doesn't support localhost chains. The SDK validates chain IDs and rejects localhost/Anvil chain IDs, making local testing incompatible with Dynamic SDK integration.
- **All tests use Arbitrum Sepolia**: Tests use real testnet infrastructure for authentic integration testing
- **Automated gas faucet**: Wallets are automatically funded with minimum ETH required (calculated dynamically)

### Test Helpers

Use test helpers from `test/helpers.ts`:

- `getTestAuthToken()` - Get real Dynamic auth token
- `getOrCreateTestWallet()` - Get or create test wallet (auto-funded with minimum ETH)
- `createTestWallet()` - Create new test wallet via API
- `fundWalletWithGas()` - Fund wallet with minimum ETH required (uses ARB_TESTNET_GAS_FAUCET_KEY)
- `TEST_CHAINS` - Test chain IDs (from `test/fixtures.ts`)
- `TEST_ADDRESSES` - Test addresses for validation (from `test/fixtures.ts`)

## Jest Configuration

**All NestJS tests run in CommonJS mode** - Jest must be configured for CJS to test against built output:

```json
{
  "preset": "ts-jest/presets/default",
  "moduleFileExtensions": ["js", "json", "ts"],
  "transform": {
    "^.+\\.ts$": ["ts-jest", {
      "tsconfig": {
        "module": "CommonJS",
        "moduleResolution": "node"
      }
    }]
  }
}
```

**Key Points:**
- Tests run against built `dist/` output (CJS), not TypeScript source
- Jest runs in CommonJS mode for stability and compatibility
- No NodeNext, no ts-node, no ESM loaders required
- Test setup files import from `dist/` (e.g., `import { validateEnv } from '../dist/config/env.schema'`)
- Server starts via `node dist/main.js` (built output)

**Test Setup Files (ESM Pattern):**
- All test setup files (`setup-server.ts`, `setup.ts`, `setup-tokens.ts`) must use ESM patterns
- Replace `__dirname` with ESM equivalent:
  ```typescript
  import { fileURLToPath } from 'node:url'
  import { dirname } from 'node:path'
  
  const __filename = fileURLToPath(import.meta.url)
  const __dirname = dirname(__filename)
  ```

## Running Tests

```bash
# E2E tests on Arbitrum Sepolia testnet (automated gas faucet)
pnpm run test:e2e

# E2E tests in watch mode
pnpm run test:e2e:watch

# E2E tests for CI (with coverage)
pnpm run test:e2e:ci

# Unit tests
pnpm run test

# Test coverage
pnpm run test:cov
```

**Prerequisites**: `ARB_TESTNET_GAS_FAUCET_KEY` environment variable must be set with a funded Arbitrum Sepolia account private key.

## Best Practices

1. **Use Real APIs**: Always prefer real API calls over mocks
2. **Test End-to-End**: Test the full flow from HTTP request to response
3. **Verify Response Structure**: Check that responses match expected formats
4. **Test Error Cases**: Include tests for validation errors, 404s, 401s
5. **Clean Up**: Use `afterAll` to close app instances
6. **Isolation**: Each test should be independent and not rely on others
7. **Documentation**: Add comments explaining what each test verifies

## Testnet Testing

### Arbitrum Sepolia Integration

Tests run exclusively against Arbitrum Sepolia testnet (chain ID: 421614):

- **Tests use real testnet**: All tests run against Arbitrum Sepolia, not local blockchain
- **Automated funding**: Wallets are automatically funded with minimum ETH required
- **Gas calculation**: Faucet calculates gas costs dynamically based on current network conditions
- **Efficient**: Only sends the minimum amount needed, not a fixed amount

### Example: Auto-Funded Wallet

```typescript
it('should send transaction with auto-funded wallet', async () => {
  // Wallet is automatically funded with minimum ETH required
  const wallet = await getOrCreateTestWallet({
    baseUrl: TEST_SERVER_URL,
    authToken,
    chainId: 421614, // Arbitrum Sepolia - will be funded automatically
  })

  // Transaction will succeed without manual funding
  const response = await request(TEST_SERVER_URL)
    .post(`/wallets/${wallet.id}/send`)
    .set('Authorization', `Bearer ${authToken}`)
    .send({
      to: TEST_ADDRESSES.EVM,
      amount: 0.0001,
    })
    .expect(200)

  expect(response.body).toHaveProperty('transactionHash')
})
```

## Future Work

- Explore custom blockchain solutions (private testnets, custom L2s) to avoid gas costs while maintaining Dynamic SDK compatibility
- Support Solana testnet with automated SOL funding
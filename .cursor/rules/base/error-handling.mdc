---
description: Error handling patterns
alwaysApply: false
---
# Error Handling Rules

## Package: @repo/error
All error handling uses `@repo/error` with:
- **Centralized catalog**: All error codes pre-registered at build time
- **Sentry integration**: Automatic error capture with PII scrubbing
- **Two-track handling**: Real errors to Sentry, safe messages to users
- **Framework-native**: Fastify handlers, React Error Boundaries, Next.js error pages

## Export Structure
Platform-specific exports (no root exports):
- `@repo/error/core` - Core functionality (types, catalog, utils) - NO Sentry
- `@repo/error/node` - Node.js/Fastify (uses `@sentry/node`)
- `@repo/error/nextjs` - Next.js (uses `@sentry/nextjs`) - works for both client and server
- `@repo/error/browser` - Browser frameworks (uses `@sentry/browser`)
- `@repo/error/react` - React components

**Import Rules**: Always use platform-specific paths (no root `@repo/error` import)

## Core Patterns

### Capture Error (Most Common)
Use `captureError` from platform-specific path (`@repo/error/nextjs`, `@repo/error/node`, etc.). Returns catalog error with safe message.

### Extract Error Message
Use `getErrorMessage` from platform-specific path for type-safe error message extraction.

## Framework Integration
See framework-specific rules:
- @.cursor/rules/backend/fastify.mdc - Error handler plugin pattern
- @.cursor/rules/frontend/nextjs.mdc - Error pages and server actions
- @.cursor/rules/frontend/react.mdc - Error boundaries

**Initialization** (idempotent - safe to call multiple times): Use `initSentry` from platform-specific path in `instrumentation.ts` (Next.js) or `index.ts` (Fastify).

## Error Code Format
Must be `UPPER_SNAKE_CASE`: `NETWORK_ERROR`, `USER_NOT_FOUND`, `AI_MODEL_ERROR`

## Best Practices
**Do**: Use `captureError` for all error reporting, use `mapHttpStatusToErrorCode` in Fastify handlers, return safe catalog errors to users, include context in `data` field, import from platform-specific paths

**Don't**: Never use `console.*` (use `@repo/utils/logger`), never expose internal error details to users, never import from root `@repo/error`, never try to register errors at runtime (all errors are pre-registered)

## Related
- @apps/docu/content/docs/architecture/error-handling.mdx - Complete guide with error catalog, build-time validation, adding new error codes
- @apps/docu/content/docs/core-concepts/packages.mdx - `@repo/error` package structure

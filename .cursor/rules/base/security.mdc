---
description: Security best practices and patterns
alwaysApply: false
---
# Security Rules

## Core Principles
- **Never trust client input**: Validate/sanitize server-side
- **Defense in depth**: Multiple security layers
- **Least privilege**: Minimum necessary permissions
- **Security by default**: Secure options default
- **Fail securely**: Deny access on security check failures

## Input Validation
- **Always validate server-side**: Never trust client-side alone
- **Validate all inputs**: Forms, query params, headers, file uploads
- **Use Zod schemas**: Runtime validation at API boundaries (see @.cursor/rules/base/typescript.mdc)
- **Sanitize output**: Prevent XSS attacks
- **Explicit type coercion**: Validate types match expectations

## Secret Management
- **No secrets in client code**: Never expose API keys/auth tokens/secrets
- **Environment variables**: Use env vars, never hardcode
- **Server-only access**: Secrets only in Server Components/API routes/server code
- **No secrets in logs**: Use logger redaction (see @.cursor/rules/base/logging.mdc)
- **No secrets in URLs**: Never in URLs/query params/client-visible locations

## Authentication & Authorization
- **httpOnly cookies**: Session tokens (prevent XSS access)
- **Secure cookies**: Secure flag in production (HTTPS only)
- **SameSite cookies**: Prevent CSRF attacks
- **Session expiration**: Proper expiration/refresh mechanisms
- **Password security**: Strong requirements, secure hashing (bcrypt/argon2), breach checking, rate limiting
- **RBAC**: Role-based access control, permission checks server-side, verify resource ownership

## Rate Limiting
- **Sensitive endpoints**: Auth endpoints, mutation endpoints, public APIs
- **Exponential backoff**: For rate limit responses
- **User identification**: By IP/session/user ID

**Pattern**: Use `@fastify/rate-limit` plugin (configured globally in app's plugins directory)

## Security Auditing
- **Log security events**: Auth attempts, permission failures, sensitive operations, security incidents
- **Audit trail**: Maintain for compliance/investigations

## API Security
- **CORS**: Restrictive origins, careful credentials handling
- **CSRF protection**: CSRF tokens, SameSite cookies, origin checking
- **SQL injection prevention**: Parameterized queries/ORM methods (never string concatenation)

## File Upload Security
- **File type validation**: Server-side (don't trust client MIME types)
- **File size limits**: Prevent DoS attacks
- **Virus scanning**: When possible
- **Secure storage**: Outside web root or proper access controls
- **Filename sanitization**: Prevent directory traversal attacks

## Related
- @.cursor/rules/base/error-handling.mdc - Error patterns
- @.cursor/rules/base/logging.mdc - Logging with secret redaction
- @.cursor/rules/base/typescript.mdc - Zod validation patterns
- @.cursor/rules/base/environment.mdc - Environment variable management
